import requests
import os
from datetime import datetime
import pytz
from bs4 import BeautifulSoup # <-- à¹€à¸£à¸²à¸ˆà¸°à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹ƒà¸«à¸¡à¹ˆà¸™à¸µà¹‰

# --- à¸ªà¹ˆà¸§à¸™à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸«à¸¥à¸±à¸ ---
# URL à¸ªà¸³à¸«à¸£à¸±à¸šà¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¹ƒà¸«à¹‰à¸¡à¸²)
SINGBURI_WATER_URL = "https://singburi.thaiwater.net/wl"
# URL à¸ªà¸³à¸£à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¸·à¹ˆà¸­à¸™ (à¹ƒà¸Šà¹‰à¸ˆà¸²à¸à¸„à¸¥à¸±à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¹‰à¸³à¹à¸«à¹ˆà¸‡à¸Šà¸²à¸•à¸´)
DAM_URL = "https://water.onwr.go.th/api/v1/stations/dam/100101/historical"

# à¸à¸¸à¸à¹à¸ˆà¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡ LINE
LINE_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_API_URL = "https://api.line.me/v2/bot/message/broadcast"

# --- à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 1: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¸¡à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”) ---

def get_singburi_data(url):
    """à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³à¸ˆà¸²à¸à¹€à¸§à¹‡à¸š singburi.thaiwater.net"""
    try:
        print("à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š singburi.thaiwater.net...")
        response = requests.get(url, timeout=20)
        response.raise_for_status()
        
        # à¹ƒà¸Šà¹‰ BeautifulSoup à¹€à¸žà¸·à¹ˆà¸­à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # à¸„à¹‰à¸™à¸«à¸²à¹à¸–à¸§à¸‚à¸­à¸‡ "à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ"
        # à¹€à¸£à¸²à¸ˆà¸°à¸«à¸² tag 'a' à¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ "à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ" à¹à¸¥à¹‰à¸§à¸«à¸²à¸žà¹ˆà¸­à¹à¸¡à¹ˆà¸‚à¸­à¸‡à¸¡à¸±à¸™à¸„à¸·à¸­à¹à¸–à¸§ <tr>
        inburi_link = soup.find('a', string=lambda text: 'à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ' in text)
        if not inburi_link:
            print("à¹„à¸¡à¹ˆà¸žà¸šà¹à¸–à¸§à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡ 'à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ' à¹ƒà¸™à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š")
            return None, None

        inburi_row = inburi_link.find_parent('tr')
        
        # à¸„à¹‰à¸™à¸«à¸²à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¹à¸–à¸§à¸™à¸±à¹‰à¸™
        columns = inburi_row.find_all('td')
        
        # à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸•à¸²à¸¡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸ªà¹ˆà¸‡à¸¡à¸²
        # à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸µà¹ˆ 1: à¸Šà¸·à¹ˆà¸­à¸­à¸³à¹€à¸ à¸­
        # à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸µà¹ˆ 2: à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (à¸¡.à¸£à¸—à¸.)
        # à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸µà¹ˆ 3: à¸£à¸°à¸”à¸±à¸šà¸•à¸¥à¸´à¹ˆà¸‡à¸‚à¸­à¸‡à¹€à¸§à¹‡à¸š
        water_level_str = columns[2].text.strip()
        water_level = float(water_level_str)
        
        print(f"à¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ: à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³ {water_level} à¸¡.à¸£à¸—à¸.")
        return water_level
        
    except Exception as e:
        print(f"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ {url}: {e}")
        return None

def get_dam_discharge():
    """à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸£à¸°à¸šà¸²à¸¢à¸™à¹‰à¸³à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ API à¸‚à¸­à¸‡ à¸ªà¸—à¸™à¸Š."""
    try:
        print("à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š API à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¸·à¹ˆà¸­à¸™...")
        # à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ 1 à¸§à¸±à¸™
        params = {'day': 1}
        response = requests.get(DAM_URL, params=params, timeout=20)
        response.raise_for_status()
        data = response.json()
        
        # à¹€à¸­à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸±à¸§à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¸•à¸±à¸§à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¹ƒà¸™ list)
        latest_data = data[-1]
        # à¸„à¹‰à¸™à¸«à¸²à¸„à¹ˆà¸²à¸à¸²à¸£à¸£à¸°à¸šà¸²à¸¢à¸™à¹‰à¸³ (discharge)
        discharge_rate = latest_data.get('discharge')
        
        if discharge_rate is None:
            print("à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ 'discharge' à¹ƒà¸™ API à¸•à¸­à¸šà¸à¸¥à¸±à¸š")
            return None
        
        print(f"à¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¸·à¹ˆà¸­à¸™à¹€à¸ˆà¹‰à¸²à¸žà¸£à¸°à¸¢à¸²: à¸£à¸°à¸šà¸²à¸¢à¸™à¹‰à¸³ {discharge_rate} à¸¥à¸š.à¸¡./à¸§à¸´à¸™à¸²à¸—à¸µ")
        return float(discharge_rate)

    except Exception as e:
        print(f"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¸·à¹ˆà¸­à¸™à¸ˆà¸²à¸ API: {e}")
        return None

# --- à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 2: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ ---
def analyze_and_create_message(inburi_level, dam_discharge):
    """à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡ LINE"""
    if inburi_level is None or dam_discharge is None:
        return "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸à¹€à¸žà¸·à¹ˆà¸­à¸—à¸³à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Log"

    # *** à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸°à¸”à¸±à¸šà¸•à¸¥à¸´à¹ˆà¸‡à¹€à¸›à¹‡à¸™ 13 à¹€à¸¡à¸•à¸£ à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ ***
    bank_height = 13.0
    distance_to_bank = bank_height - inburi_level
    
    # à¸•à¸£à¸£à¸à¸°à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
    if dam_discharge > 2400 or distance_to_bank < 1.0:
        status_emoji = "ðŸŸ¥"
        status_title = "â€¼ï¸ à¸›à¸£à¸°à¸à¸²à¸¨à¹€à¸•à¸·à¸­à¸™à¸ à¸±à¸¢à¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡à¸ªà¸¸à¸” â€¼ï¸"
        recommendation = ("à¸„à¸³à¹à¸™à¸°à¸™à¸³:\n1. à¹€à¸•à¸£à¸µà¸¢à¸¡à¸žà¸£à¹‰à¸­à¸¡à¸­à¸žà¸¢à¸žà¸«à¸²à¸à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹€à¸ªà¸µà¹ˆà¸¢à¸‡\n2. à¸‚à¸™à¸¢à¹‰à¸²à¸¢à¸—à¸£à¸±à¸žà¸¢à¹Œà¸ªà¸´à¸™à¸‚à¸¶à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸¹à¸‡à¹‚à¸”à¸¢à¸”à¹ˆà¸§à¸™\n3. à¸‡à¸”à¹ƒà¸Šà¹‰à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸ªà¸±à¸à¸ˆà¸£à¸£à¸´à¸¡à¹à¸¡à¹ˆà¸™à¹‰à¸³")
    elif dam_discharge > 1800 or distance_to_bank < 2.0:
        status_emoji = "ðŸŸ¨"
        status_title = "â€¼ï¸ à¸›à¸£à¸°à¸à¸²à¸¨à¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡ â€¼ï¸"
        recommendation = ("à¸„à¸³à¹à¸™à¸°à¸™à¸³:\n1. à¸šà¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸£à¸´à¸¡à¸•à¸¥à¸´à¹ˆà¸‡à¸™à¸­à¸à¸„à¸±à¸™à¸à¸±à¹‰à¸™à¸™à¹‰à¸³ à¹ƒà¸«à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸™à¸‚à¸­à¸‡à¸‚à¸¶à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸¹à¸‡\n2. à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¹ƒà¸à¸¥à¹‰à¸Šà¸´à¸”")
    else:
        status_emoji = "ðŸŸ©"
        status_title = "à¸ªà¸–à¸²à¸™à¸°à¸›à¸à¸•à¸´"
        recommendation = "à¸ªà¸£à¸¸à¸›: à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¸™à¹‰à¸³à¸¢à¸±à¸‡à¸›à¸à¸•à¸´ à¹„à¸¡à¹ˆà¸™à¹ˆà¸²à¸à¸±à¸‡à¸§à¸¥ à¸‚à¸­à¹ƒà¸«à¹‰à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¹ƒà¸Šà¹‰à¸Šà¸µà¸§à¸´à¸•à¹„à¸”à¹‰à¸•à¸²à¸¡à¸›à¸à¸•à¸´à¸„à¸£à¸±à¸š"

    tz = pytz.timezone('Asia/Bangkok')
    now = datetime.now(tz)
    
    message = (
        f"{status_emoji} {status_title}\n"
        f"à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¸™à¹‰à¸³à¹€à¸ˆà¹‰à¸²à¸žà¸£à¸°à¸¢à¸² à¸­.à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ\n"
        f"à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸—à¸µà¹ˆ: {now.strftime('%d/%m/%Y %H:%M')} à¸™.\n\n"
        f"â€¢ à¸£à¸°à¸”à¸±à¸šà¸™à¹‰à¸³ (à¸­à¸´à¸™à¸—à¸£à¹Œà¸šà¸¸à¸£à¸µ): {inburi_level:.2f} à¸¡.à¸£à¸—à¸.\n"
        f"  (à¸•à¹ˆà¸³à¸à¸§à¹ˆà¸²à¸•à¸¥à¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹„à¸§à¹‰ {distance_to_bank:.2f} à¸¡.)\n"
        f"â€¢ à¹€à¸‚à¸·à¹ˆà¸­à¸™à¹€à¸ˆà¹‰à¸²à¸žà¸£à¸°à¸¢à¸²: à¸£à¸°à¸šà¸²à¸¢à¸™à¹‰à¸³ {dam_discharge:,.0f} à¸¥à¸š.à¸¡./à¸§à¸´à¸™à¸²à¸—à¸µ\n\n"
        f"{recommendation}"
    )
    return message

# --- à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 3: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸›à¸—à¸µà¹ˆ LINE (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡) ---
def send_line_broadcast(message):
    if not LINE_TOKEN:
        print("à¹„à¸¡à¹ˆà¸žà¸š LINE_CHANNEL_ACCESS_TOKEN")
        return
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {LINE_TOKEN}"}
    payload = {"messages": [{"type": "text", "text": message}]}
    try:
        response = requests.post(LINE_API_URL, headers=headers, json=payload, timeout=10)
        response.raise_for_status()
        print("à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ Broadcast à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!")
    except Exception as e:
        print(f"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡ LINE Broadcast: {e}")

# --- à¸ªà¹ˆà¸§à¸™à¸—à¸³à¸‡à¸²à¸™à¸«à¸¥à¸±à¸ (Main) ---
if __name__ == "__main__":
    print("===== à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸£à¸°à¸šà¸šà¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡à¸™à¹‰à¸³ v3.0 =====")
    
    # 1. à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    inburi_level = get_singburi_data(SINGBURI_WATER_URL)
    dam_discharge = get_dam_discharge()
    
    # 2. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    final_message = analyze_and_create_message(inburi_level, dam_discharge)
    print("\n--- à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸ˆà¸°à¸ªà¹ˆà¸‡ ---")
    print(final_message)
    print("---------------------\n")
    
    # 3. à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    send_line_broadcast(final_message)
        
    print("===== à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™ =====")
